# 配置驱动的页面生成系统

## 1. 系统概述

### 1.1 目标
通过配置文件驱动的方式，简化新页面的创建流程，将原本需要修改多个文件的操作简化为仅修改一个配置文件。

### 1.2 核心优势
- **简化流程**：新增页面只需修改配置文件
- **标准化**：统一的页面结构和资源配置
- **可维护性**：集中管理所有页面配置
- **向后兼容**：不破坏现有代码结构

## 2. 系统架构

### 2.1 文件结构
```
src/
├── config/
│   ├── pages.json          # 页面配置文件
│   └── pageTemplates.js    # 页面模板配置
├── components/
│   ├── DynamicPage.vue     # 动态页面组件
│   └── ResourceRenderer.vue # 资源渲染组件
├── utils/
│   ├── pageGenerator.js    # 页面生成工具
│   └── routeGenerator.js   # 路由生成工具
└── pages/
    └── generated/          # 自动生成的页面目录
```

## 3. 实施步骤

### 3.1 第一步：创建页面配置文件

创建 `src/config/pages.json`：

```json
{
  "pages": [
    {
      "id": "square",
      "title": "广场",
      "path": "/square",
      "image": "https://uiweb.oss-cn-chengdu.aliyuncs.com/img/目录页/广场页.png",
      "category": "main",
      "components": {
        "phone": "square/square-phone",
        "pad": "square/square-pad"
      },
      "resources": [
        {
          "id": 1,
          "name": "大banner前景图",
          "type": "upload",
          "widthExact": 1248,
          "heightExact": 384,
          "helpLink": "https://alidocs.dingtalk.com/i/nodes/mExel2BLV54K0MnQCxk2Pq2wWgk9rpMq"
        },
        {
          "id": 2,
          "name": "大banner背景图",
          "type": "upload",
          "widthExact": 1248,
          "heightExact": 344,
          "helpLink": "https://alidocs.dingtalk.com/i/nodes/mExel2BLV54K0MnQCxk2Pq2wWgk9rpMq"
        },
        {
          "id": 3,
          "name": "小banner",
          "type": "upload-picture-card",
          "minSize": { "width": 480, "height": 270 },
          "helpLink": "https://alidocs.dingtalk.com/i/nodes/gwva2dxOW4KX7gmQCQN1X2oz8bkz3BRL"
        }
      ]
    },
    {
      "id": "homeActivityCard",
      "title": "学习页活动卡片",
      "path": "/HomeActivityCard",
      "image": "@/assets/img/目录页/首页活动卡片.png",
      "category": "study",
      "components": {
        "phone": "study/HomeActivityCard/Box-phone",
        "pad": "study/HomeActivityCard/Box-pad"
      },
      "resources": [
        {
          "id": 1,
          "name": "资源图",
          "type": "upload",
          "widthExact": 360,
          "heightExact": 264,
          "helpLink": "https://alidocs.dingtalk.com/i/nodes/QG53mjyd80RMX42QtXj1pmkGV6zbX04v"
        },
        {
          "id": 2,
          "name": "配色",
          "type": "select",
          "options": [
            { "value": "yellow", "label": "黄" },
            { "value": "orange", "label": "橙" },
            { "value": "brown", "label": "棕" },
            { "value": "blue", "label": "蓝" },
            { "value": "green", "label": "绿" },
            { "value": "purple", "label": "紫" },
            { "value": "pink", "label": "粉" },
            { "value": "red", "label": "红" },
            { "value": "grassy", "label": "草" },
            { "value": "cyan", "label": "青" }
          ],
          "helpLink": "https://alidocs.dingtalk.com/i/nodes/QG53mjyd80RMX42QtXj1pmkGV6zbX04v"
        },
        {
          "id": 3,
          "name": "主标题",
          "type": "input",
          "placeholder": "主标题",
          "eventName": "updateTitle"
        },
        {
          "id": 4,
          "name": "副标题",
          "type": "input",
          "placeholder": "副标题",
          "eventName": "updateSubtitle"
        },
        {
          "id": 5,
          "name": "按钮文案",
          "type": "input",
          "placeholder": "按钮文案",
          "eventName": "updateButtonText"
        }
      ]
    }
  ]
}
```

### 3.2 第二步：创建动态页面组件

创建 `src/components/DynamicPage.vue`：

```vue
<template>
  <div class="page">
    <div class="canvas">
      <div class="phone-frame">
        <component 
          :is="phoneComponent" 
          v-bind="componentProps" 
        />
      </div>
      <div class="pad-frame">
        <component 
          :is="padComponent" 
          v-bind="componentProps" 
        />
      </div>
    </div>
    
    <div class="resource-list">
      <div class="menu">
        <div class="title"><span>资源列表</span></div>
        <div class="resources">
          <div 
            v-for="resource in pageConfig.resources" 
            :key="resource.id" 
            class="list"
            :class="{ 'flex-column': resource.type === 'upload-picture-card' }"
          >
            <div class="zyname">
              <span>{{ resource.name }}</span>
              <a 
                v-if="resource.helpLink" 
                :href="resource.helpLink" 
                target="_blank"
              >
                <Help theme="outline" size="12" fill="#666" />
              </a>
            </div>
            
            <!-- 资源渲染组件 -->
            <ResourceRenderer 
              :resource="resource"
              @resource-change="handleResourceChange"
            />
          </div>
        </div>
      </div>
    </div>
  </div>
</template>

<script setup>
import { ref, computed, defineAsyncComponent } from 'vue'
import { Help } from '@icon-park/vue-next'
import ResourceRenderer from './ResourceRenderer.vue'
import { useRoute } from 'vue-router'
import pagesConfig from '@/config/pages.json'

const route = useRoute()

// 根据路由路径获取页面配置
const pageConfig = computed(() => {
  return pagesConfig.pages.find(page => page.path === route.path) || {}
})

// 动态加载组件
const phoneComponent = computed(() => {
  if (!pageConfig.value.components?.phone) return null
  return defineAsyncComponent(() => 
    import(`@/components/${pageConfig.value.components.phone}.vue`)
  )
})

const padComponent = computed(() => {
  if (!pageConfig.value.components?.pad) return null
  return defineAsyncComponent(() => 
    import(`@/components/${pageConfig.value.components.pad}.vue`)
  )
})

// 组件属性
const componentProps = ref({})

/**
 * 处理资源变化事件
 * @param {Object} data - 资源变化数据
 */
const handleResourceChange = (data) => {
  const { resourceId, value, eventName } = data
  
  // 更新组件属性
  if (eventName) {
    componentProps.value[eventName] = value
  }
  
  // 触发全局事件（保持与现有系统兼容）
  if (resourceId) {
    const event = `updateImage${resourceId}`
    emitter.emit(event, value)
  }
}
</script>

<style scoped>
.page {
  font-size: 12px;
  width: 100%;
  height: 100%;
}

.canvas {
  display: flex;
  justify-content: center;
  align-items: center;
  flex-wrap: wrap;
  gap: 2.5em;
  width: 100%;
  background-color: #edeff3;
}

.phone-frame {
  width: 23.4375em;
  height: 50.75em;
  margin: 1.875em 0;
  background-color: #fff;
  display: flex;
  flex-direction: column;
  align-items: center;
  overflow: hidden;
  border-radius: 1.25em;
  box-shadow: 0em 0.25em 3.125em 0em rgba(0, 0, 0, 0.08);
}

.pad-frame {
  width: 53.75em;
  height: 50.75em;
  margin: 1.875em 0;
  background-color: #fff;
  display: flex;
  flex-direction: column;
  align-items: center;
  overflow: hidden;
  border-radius: 1.25em;
  box-shadow: 0em 0.25em 3.125em 0em rgba(0, 0, 0, 0.08);
}

.resource-list {
  width: 25rem;
  height: 100vh;
  background-color: #fff;
  border-left: 1px solid #f0f0f0;
  overflow-y: auto;
}

.menu {
  padding: 1.25rem;
}

.title {
  display: flex;
  align-items: center;
  font-size: 1.25rem;
  font-weight: 500;
  line-height: 150%;
  width: 100%;
  height: 3.75rem;
  border-bottom: 0.0625rem solid #f5f4f4;
  margin-bottom: 1.25rem;
}

.resources {
  display: flex;
  flex-direction: column;
  gap: 1.25rem;
}

.list {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 0.625rem;
}

.list.flex-column {
  flex-direction: column;
  align-items: flex-start;
  gap: 0.75rem;
}

.zyname {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  font-size: 0.875rem;
  color: #333;
}
</style>
```

### 3.3 第三步：创建资源渲染组件

创建 `src/components/ResourceRenderer.vue`：

```vue
<template>
  <div class="resource-renderer">
    <!-- 图片上传组件 -->
    <upload 
      v-if="resource.type === 'upload'"
      :id="resource.id"
      :width-exact="resource.widthExact"
      :height-exact="resource.heightExact"
      :min-width="resource.minWidth"
      :max-width="resource.maxWidth"
      :min-height="resource.minHeight"
      :max-height="resource.maxHeight"
      @upload="handleUpload"
    />
    
    <!-- 图片卡片上传组件 -->
    <upload-picture-card 
      v-else-if="resource.type === 'upload-picture-card'"
      :id="resource.id"
      :min-size="resource.minSize"
      @upload="handleUpload"
    />
    
    <!-- 颜色选择器 -->
    <a-color-picker
      v-else-if="resource.type === 'color'"
      v-model="colorValue"
      show-text
      disabled-alpha
      size="mini"
      show-preset
      :preset-colors="resource.presetColors || defaultPresetColors"
      @change="handleColorChange"
    />
    
    <!-- 下拉选择 -->
    <a-select
      v-else-if="resource.type === 'select'"
      v-model="selectValue"
      :style="{ width: resource.width || '110px' }"
      size="mini"
      :placeholder="resource.placeholder || '选择'"
      :trigger-props="{ autoFitPopupMinWidth: true }"
      @change="handleSelectChange"
    >
      <a-option 
        v-for="option in resource.options" 
        :key="option.value" 
        :value="option.value"
      >
        {{ option.label }}
      </a-option>
    </a-select>
    
    <!-- 文本输入 -->
    <a-input
      v-else-if="resource.type === 'input'"
      v-model="inputValue"
      :placeholder="resource.placeholder"
      allow-clear
      @update:model-value="handleInputChange"
    />
  </div>
</template>

<script setup>
import { ref, defineEmits } from 'vue'
import upload from '@/components/general/upload/upload-simple.vue'
import uploadPictureCard from '@/components/general/upload/upload-picture-card.vue'

const props = defineProps({
  resource: {
    type: Object,
    required: true
  }
})

const emit = defineEmits(['resource-change'])

// 响应式数据
const colorValue = ref('#1890ff')
const selectValue = ref('')
const inputValue = ref('')

// 默认预设颜色
const defaultPresetColors = [
  '#1890ff', '#52c41a', '#faad14', '#f5222d', 
  '#722ed1', '#13c2c2', '#eb2f96', '#fa541c'
]

/**
 * 处理文件上传
 * @param {File} file - 上传的文件
 */
const handleUpload = (file) => {
  const url = URL.createObjectURL(file)
  emit('resource-change', {
    resourceId: props.resource.id,
    value: url,
    type: 'upload'
  })
}

/**
 * 处理颜色变化
 * @param {string} color - 选择的颜色值
 */
const handleColorChange = (color) => {
  emit('resource-change', {
    resourceId: props.resource.id,
    value: color,
    type: 'color',
    eventName: props.resource.eventName
  })
}

/**
 * 处理下拉选择变化
 * @param {string} value - 选择的值
 */
const handleSelectChange = (value) => {
  emit('resource-change', {
    resourceId: props.resource.id,
    value: value,
    type: 'select',
    eventName: props.resource.eventName
  })
}

/**
 * 处理输入框变化
 * @param {string} value - 输入的值
 */
const handleInputChange = (value) => {
  emit('resource-change', {
    resourceId: props.resource.id,
    value: value,
    type: 'input',
    eventName: props.resource.eventName
  })
}
</script>

<style scoped>
.resource-renderer {
  display: flex;
  align-items: center;
}
</style>
```

### 3.4 第四步：修改路由配置

修改 `src/router/router.ts`：

```typescript
import { createRouter, createWebHistory } from 'vue-router'
import menu from '@/pages/menu.vue'
import DynamicPage from '@/components/DynamicPage.vue'
import pagesConfig from '@/config/pages.json'

// 静态路由
const staticRoutes = [
  {
    path: '/',
    component: menu,
  },
  {
    path: '/menu',
    component: menu,
  }
]

// 动态生成路由
const dynamicRoutes = pagesConfig.pages.map(page => ({
  path: page.path,
  component: DynamicPage,
  meta: {
    pageId: page.id,
    title: page.title
  }
}))

// 保留现有的特殊页面路由
const specialRoutes = [
  {
    path: '/popup',
    component: () => import('@/pages/pop-up.vue'),
  },
  {
    path: '/bottom-pop-up',
    component: () => import('@/pages/bottom-pop-up.vue'),
  }
]

const router = createRouter({
  history: createWebHistory(),
  routes: [
    ...staticRoutes,
    ...dynamicRoutes,
    ...specialRoutes
  ],
})

export default router
```

### 3.5 第五步：修改菜单配置

修改 `src/pages/menu.vue`：

```vue
<template>
  <div class="main">
    <div v-for="(route, index) in allRoutes" :key="index" class="box">
      <router-link :to="route.path" style="color: #404040">
        <img :src="route.image" :alt="route.title" />
        <div class="box-title">{{ route.title }}</div>
      </router-link>
    </div>

    <!-- 根据域名判断是否显示底部文字 -->
    <div v-if="shouldShowFooterText" class="footer-text">
      <div class="footer-links">
        <a href="http://10.130.33.131:3001/" target="_blank" class="link-item">
          <span class="link-label">局域网网址（推荐）：</span>
          <span class="link-url">10.130.33.131:3001</span>
        </a>
        <span class="divider">|</span>
        <a
          href="https://jojo-preview.netlify.app/"
          target="_blank"
          class="link-item"
        >
          <span class="link-label">公网网址（备用）：</span>
          <span class="link-url">jojo-preview.netlify.app</span>
        </a>
      </div>
    </div>
  </div>
</template>

<script setup>
import { ref, computed } from 'vue'
import pagesConfig from '@/config/pages.json'

// 从配置文件加载页面路由
const configRoutes = pagesConfig.pages.map(page => ({
  path: page.path,
  image: page.image,
  title: page.title,
  category: page.category
}))

// 手动维护的特殊路由
const specialRoutes = ref([
  {
    path: '/popup',
    image: 'https://uiweb.oss-cn-chengdu.aliyuncs.com/img/目录页/通用弹窗.png',
    title: '通用弹窗',
    category: 'special'
  },
  {
    path: '/bottom-pop-up',
    image: 'https://uiweb.oss-cn-chengdu.aliyuncs.com/img/目录页/底部弹窗_3c58fec3.png',
    title: '底部弹窗',
    category: 'special'
  }
])

// 合并所有路由
const allRoutes = computed(() => {
  return [...configRoutes, ...specialRoutes.value]
})

const shouldShowFooterText = computed(() => {
  const hostname = window.location.hostname
  return [
    '127.0.0.1',
    '188.8.12.201',
    'jojo-preview.netlify.app',
    'https://www.jojoui.work/',
  ].includes(hostname)
})
</script>

<!-- 样式保持不变 -->
<style scoped>
/* 保持原有样式 */
</style>
```

## 4. 使用指南

### 4.1 新增页面流程

1. **在 `pages.json` 中添加页面配置**：
```json
{
  "id": "newPage",
  "title": "新页面",
  "path": "/new-page",
  "image": "图片URL",
  "category": "study",
  "components": {
    "phone": "study/NewPage/phone",
    "pad": "study/NewPage/pad"
  },
  "resources": [
    {
      "id": 1,
      "name": "背景图",
      "type": "upload",
      "widthExact": 375,
      "heightExact": 200,
      "helpLink": "帮助链接"
    }
  ]
}
```

2. **创建对应的组件文件**：
   - `src/components/study/NewPage/phone.vue`
   - `src/components/study/NewPage/pad.vue`

3. **重启开发服务器**（路由会自动生成）

### 4.2 资源类型配置

#### 图片上传
```json
{
  "type": "upload",
  "widthExact": 375,
  "heightExact": 200,
  "minWidth": 300,
  "maxWidth": 500
}
```

#### 颜色选择器
```json
{
  "type": "color",
  "presetColors": ["#ff0000", "#00ff00", "#0000ff"]
}
```

#### 下拉选择
```json
{
  "type": "select",
  "options": [
    { "value": "option1", "label": "选项1" },
    { "value": "option2", "label": "选项2" }
  ]
}
```

#### 文本输入
```json
{
  "type": "input",
  "placeholder": "请输入内容",
  "eventName": "updateTitle"
}
```

## 5. 迁移指南

### 5.1 现有页面迁移

1. **将现有页面配置添加到 `pages.json`**
2. **保留现有组件文件不变**
3. **逐步迁移到动态页面系统**

### 5.2 兼容性处理

- 保留现有的事件系统（emitter）
- 保持组件接口不变
- 支持渐进式迁移

## 6. 扩展功能

### 6.1 页面模板
可以创建页面模板，快速生成相似页面：

```json
{
  "templates": {
    "studyPage": {
      "components": {
        "phone": "study/template/phone",
        "pad": "study/template/pad"
      },
      "defaultResources": [
        {
          "name": "背景图",
          "type": "upload",
          "widthExact": 375,
          "heightExact": 200
        }
      ]
    }
  }
}
```

### 6.2 条件渲染
支持根据条件显示不同的资源：

```json
{
  "resources": [
    {
      "name": "主题色",
      "type": "color",
      "condition": {
        "field": "theme",
        "value": "custom"
      }
    }
  ]
}
```

## 7. 总结

通过配置驱动的页面生成系统，我们实现了：

1. **简化流程**：新增页面只需修改配置文件
2. **标准化管理**：统一的页面结构和资源配置
3. **向后兼容**：不破坏现有代码结构
4. **易于维护**：集中管理所有页面配置
5. **可扩展性**：支持新的资源类型和功能

这个系统将大大提高开发效率，减少重复代码，并使页面管理更加规范化。
        